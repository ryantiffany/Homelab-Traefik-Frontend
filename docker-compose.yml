version: '3'
services:
  traefik:
    image: "traefik:v2.2"
    container_name: "traefik"
    hostname: "traefik"
    restart: always
    environment:
      - "DNSIMPLE_OAUTH_TOKEN=${DNSIMPLE_OAUTH_TOKEN}"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/traefik/traefik.yaml:/traefik.yaml
      - ./config/traefik/users.txt:/users.txt
      - ./config/traefik/acme.json:/acme.json
      - ./config/traefik/dynamic:/dynamic
      - /run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik
    dns:
      - 1.1.1.1
  consul:
    image: consul:1.9.3
    container_name: "consul"
    hostname: "consul"
    networks:
      - traefik
      - internal
    dns:
      - 1.1.1.1
    volumes:
      - ./config/traefik/users.txt:/users.txt
      - ./config/consul/server.hcl:/etc/consul/server.hcl
      - ./config/consul/client.hcl:/etc/consul/client.hcl
      - ./data/consul:/opt/consul
  influx:
    image: influxdb:2.0.4
    container_name: "influx"
    hostname: "influx"
    networks:
      - traefik
      - internal
    restart: always
    dns:
      - 1.1.1.1
    labels:
      - traefik.enable=true
      - traefik.http.routers.influx.rule=Host(`influx.lab.tiffany-family.net`)
      - traefik.http.routers.influx.entrypoints=websecure
      - traefik.http.routers.influx.tls=true
      - traefik.http.routers.influx.tls.certresolver=letsencrypt
      - traefik.http.routers.influx.service=influx
      - traefik.http.services.influx.loadbalancer.server.port=8086
      - traefik.http.middlewares=simpleAuth
    environment:
      - INFLUXDB_ADMIN_USER_PASSWORD=${INFLUXDB_ADMIN_USER_PASSWORD}
      - INFLUXDB_USER=ryan
      - INFLUXDB_USER_PASSWORD=${INFLUXDB_USER_PASSWORD}
      - INFLUX_TELEGRAF_TOKEN=${INFLUX_TELEGRAF_TOKEN}
    volumes:
      - ./config/influxdb/influx-configs:/etc/influxdb2/influx-configs
  gitlab:
    image: 'gitlab/gitlab-ee:latest'
    restart: always
    hostname: 'git.lab.tiffany-family.net'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'https://git.lab.tiffany-family.net'
        nginx['ssl_session_timeout'] = "5m"
        nginx['listen_port'] = 80
        nginx['listen_https'] = false
        gitlab_rails['backup_archive_permissions'] = 0644
        gitlab_rails['backup_keep_time'] = 1468800
        gitlab_rails['backup_upload_connection'] = {
          'provider' => 'AWS',
          'region' => 'us-east-1',
          'aws_access_key_id' => "${S3_ACCESS_KEY}",
          'aws_secret_access_key' => "${S3_SECRET_KEY}",
          'host' => "${S3_ENDPOINT}"
        }
        gitlab_rails['backup_upload_remote_directory'] = 'jupiter-gitlab-backup'
    ports:
      - '8022:22'
    labels:
      - traefik.enable=true
      - traefik.http.routers.gitlab.rule=Host(`git.lab.tiffany-family.net`)
      - traefik.http.routers.gitlab.entrypoints=websecure
      - traefik.http.routers.gitlab.tls=true
      - traefik.http.routers.gitlab.tls.certresolver=letsencrypt
      - traefik.http.routers.gitlab.service=gitlab
      - traefik.http.services.gitlab.loadbalancer.server.port=80
      - traefik.http.middlewares=simpleAuth
    volumes:
      - './config/gitlab:/etc/gitlab'
      - './logs/gitlab:/var/log/gitlab'
      - './data/gitlab:/var/opt/gitlab'
  grafana:
    image: grafana/grafana
    container_name: "grafana"
    hostname: "grafana"
    environment:
      - GF_INSTALL_PLUGINS="grafana-clock-panel,grafana-simple-json-datasource,diagram,gitlab,github"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./config/grafana:/etc/grafana
    networks:
      - internal
      - traefik
    dns:
      - 1.1.1.1
networks:
  traefik:
    external: true
  internal: 
    external: false
